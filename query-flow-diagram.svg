<svg viewBox="0 0 1400 2000" xmlns="http://www.w3.org/2000/svg">
  <!-- Define styles -->
  <defs>
    <style>
      .frontend { fill: #E3F2FD; stroke: #1976D2; stroke-width: 2; }
      .backend { fill: #FFF3E0; stroke: #F57C00; stroke-width: 2; }
      .rag { fill: #F3E5F5; stroke: #7B1FA2; stroke-width: 2; }
      .ai { fill: #E8F5E9; stroke: #388E3C; stroke-width: 2; }
      .tools { fill: #FFF9C4; stroke: #F9A825; stroke-width: 2; }
      .vector { fill: #FFE0B2; stroke: #E64A19; stroke-width: 2; }
      .db { fill: #ECEFF1; stroke: #455A64; stroke-width: 2; }

      .arrow { fill: none; stroke: #333; stroke-width: 2; marker-end: url(#arrowhead); }
      .arrow-tool { fill: none; stroke: #F9A825; stroke-width: 2.5; marker-end: url(#arrowhead-tool); stroke-dasharray: 5,5; }
      .arrow-return { fill: none; stroke: #1976D2; stroke-width: 2; marker-end: url(#arrowhead-return); }

      .title { font-family: Arial, sans-serif; font-size: 16px; font-weight: bold; fill: #333; }
      .subtitle { font-family: Arial, sans-serif; font-size: 13px; fill: #555; }
      .label { font-family: Arial, sans-serif; font-size: 12px; fill: #666; }
      .code { font-family: 'Courier New', monospace; font-size: 11px; fill: #444; }
      .section-title { font-family: Arial, sans-serif; font-size: 18px; font-weight: bold; fill: #1976D2; }
    </style>

    <!-- Arrow markers -->
    <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#333" />
    </marker>
    <marker id="arrowhead-tool" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#F9A825" />
    </marker>
    <marker id="arrowhead-return" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#1976D2" />
    </marker>
  </defs>

  <!-- Title -->
  <text x="700" y="30" class="section-title" text-anchor="middle">RAG Chatbot Query Flow</text>

  <!-- STEP 1: User Input -->
  <rect x="50" y="60" width="280" height="100" class="frontend" rx="5"/>
  <text x="190" y="85" class="title" text-anchor="middle">1. USER INPUT</text>
  <text x="190" y="105" class="subtitle" text-anchor="middle">script.js - sendMessage()</text>
  <text x="60" y="130" class="label">• User types query</text>
  <text x="60" y="148" class="label">• Show loading spinner</text>

  <!-- Arrow down -->
  <path d="M 190 160 L 190 200" class="arrow"/>
  <text x="200" y="185" class="code">POST /api/query</text>

  <!-- STEP 2: API Endpoint -->
  <rect x="50" y="200" width="280" height="100" class="backend" rx="5"/>
  <text x="190" y="225" class="title" text-anchor="middle">2. API ENDPOINT</text>
  <text x="190" y="245" class="subtitle" text-anchor="middle">app.py - query_documents()</text>
  <text x="60" y="270" class="label">• Create/get session_id</text>
  <text x="60" y="288" class="label">• Call rag_system.query()</text>

  <!-- Arrow down -->
  <path d="M 190 300 L 190 340" class="arrow"/>

  <!-- STEP 3: RAG System -->
  <rect x="50" y="340" width="280" height="120" class="rag" rx="5"/>
  <text x="190" y="365" class="title" text-anchor="middle">3. RAG ORCHESTRATOR</text>
  <text x="190" y="385" class="subtitle" text-anchor="middle">rag_system.py - query()</text>
  <text x="60" y="410" class="label">• Get conversation history</text>
  <text x="60" y="428" class="label">• Prepare search tools</text>
  <text x="60" y="446" class="label">• Call AI generator</text>

  <!-- Arrow down -->
  <path d="M 190 460 L 190 500" class="arrow"/>

  <!-- STEP 4: AI Generator - First Call -->
  <rect x="50" y="500" width="280" height="140" class="ai" rx="5"/>
  <text x="190" y="525" class="title" text-anchor="middle">4. AI GENERATOR (1st Call)</text>
  <text x="190" y="545" class="subtitle" text-anchor="middle">ai_generator.py</text>
  <text x="60" y="570" class="code">client.messages.create(</text>
  <text x="70" y="588" class="code">  model="claude-sonnet-4.5",</text>
  <text x="70" y="606" class="code">  tools=[search_tool],</text>
  <text x="70" y="624" class="code">  messages=[user_query]</text>
  <text x="60" y="642" class="code">)</text>

  <!-- Decision diamond -->
  <path d="M 190 640 L 270 720 L 190 800 L 110 720 Z" fill="#FFE082" stroke="#F57C00" stroke-width="2"/>
  <text x="190" y="715" class="label" text-anchor="middle">Claude</text>
  <text x="190" y="730" class="label" text-anchor="middle">needs to</text>
  <text x="190" y="745" class="label" text-anchor="middle">search?</text>

  <!-- YES path - Tool Use -->
  <path d="M 270 720 L 450 720" class="arrow-tool"/>
  <text x="340" y="710" class="label" font-weight="bold">YES</text>

  <!-- STEP 5: Tool Manager -->
  <rect x="450" y="670" width="280" height="100" class="tools" rx="5"/>
  <text x="590" y="695" class="title" text-anchor="middle">5. TOOL MANAGER</text>
  <text x="590" y="715" class="subtitle" text-anchor="middle">search_tools.py</text>
  <text x="460" y="740" class="label">• Execute search_course_content</text>
  <text x="460" y="758" class="code">  query, course_name, lesson#</text>

  <!-- Arrow down -->
  <path d="M 590 770 L 590 810" class="arrow"/>

  <!-- STEP 6: Course Search Tool -->
  <rect x="450" y="810" width="280" height="100" class="tools" rx="5"/>
  <text x="590" y="835" class="title" text-anchor="middle">6. COURSE SEARCH TOOL</text>
  <text x="590" y="855" class="subtitle" text-anchor="middle">search_tools.py - execute()</text>
  <text x="460" y="880" class="label">• Call vector_store.search()</text>
  <text x="460" y="898" class="label">• Track sources</text>

  <!-- Arrow down -->
  <path d="M 590 910 L 590 950" class="arrow"/>

  <!-- STEP 7: Vector Store -->
  <rect x="450" y="950" width="280" height="140" class="vector" rx="5"/>
  <text x="590" y="975" class="title" text-anchor="middle">7. VECTOR STORE</text>
  <text x="590" y="995" class="subtitle" text-anchor="middle">vector_store.py - search()</text>
  <text x="460" y="1020" class="label">① Resolve course name</text>
  <text x="470" y="1038" class="code">  semantic search in catalog</text>
  <text x="460" y="1056" class="label">② Build filter (course + lesson)</text>
  <text x="460" y="1074" class="label">③ Search content chunks</text>

  <!-- Arrow down -->
  <path d="M 590 1090 L 590 1130" class="arrow"/>

  <!-- STEP 8: ChromaDB -->
  <rect x="450" y="1130" width="280" height="120" class="db" rx="5"/>
  <text x="590" y="1155" class="title" text-anchor="middle">8. CHROMADB QUERY</text>
  <text x="460" y="1180" class="label">• Convert query to embedding</text>
  <text x="460" y="1198" class="code">  Sentence Transformer</text>
  <text x="460" y="1216" class="label">• Cosine similarity search</text>
  <text x="460" y="1234" class="label">• Return top 5 chunks + metadata</text>

  <!-- Arrow back up -->
  <path d="M 730 1190 L 880 1190 L 880 1020 L 730 1020" class="arrow-return"/>
  <text x="885" y="1110" class="label">chunks +</text>
  <text x="885" y="1125" class="label">metadata</text>

  <!-- Format results box -->
  <rect x="760" y="950" width="260" height="80" class="tools" rx="5"/>
  <text x="890" y="975" class="subtitle" text-anchor="middle">Format Results</text>
  <text x="770" y="995" class="code">[Course - Lesson N]</text>
  <text x="770" y="1010" class="code">chunk content...</text>
  <text x="770" y="1025" class="code">sources = ["Course-L1"]</text>

  <!-- Arrow back to AI Generator -->
  <path d="M 880 950 L 880 580 L 330 580" class="arrow-return"/>
  <text x="890" y="750" class="label">search</text>
  <text x="890" y="765" class="label">results</text>

  <!-- STEP 9: AI Generator - Second Call -->
  <rect x="50" y="850" width="280" height="140" class="ai" rx="5"/>
  <text x="190" y="875" class="title" text-anchor="middle">9. AI GENERATOR (2nd Call)</text>
  <text x="190" y="895" class="subtitle" text-anchor="middle">With search results</text>
  <text x="60" y="920" class="code">messages = [</text>
  <text x="70" y="938" class="code">  user_query,</text>
  <text x="70" y="956" class="code">  assistant_tool_use,</text>
  <text x="70" y="974" class="code">  tool_results</text>
  <text x="60" y="992" class="code">]</text>

  <!-- NO path - Direct Answer -->
  <path d="M 110 720 L 30 720 L 30 920 L 50 920" class="arrow"/>
  <text x="15" y="820" class="label" font-weight="bold">NO</text>
  <text x="5" y="835" class="code" font-size="10">direct</text>
  <text x="5" y="847" class="code" font-size="10">answer</text>

  <!-- Arrow down from AI Generator 2 -->
  <path d="M 190 990 L 190 1030" class="arrow"/>

  <!-- STEP 10: Collect Results -->
  <rect x="50" y="1030" width="280" height="120" class="rag" rx="5"/>
  <text x="190" y="1055" class="title" text-anchor="middle">10. COLLECT RESULTS</text>
  <text x="190" y="1075" class="subtitle" text-anchor="middle">rag_system.py</text>
  <text x="60" y="1100" class="label">• Get sources from tool_manager</text>
  <text x="60" y="1118" class="label">• Reset sources</text>
  <text x="60" y="1136" class="label">• Update conversation history</text>

  <!-- Arrow down -->
  <path d="M 190 1150 L 190 1190" class="arrow"/>

  <!-- STEP 11: API Response -->
  <rect x="50" y="1190" width="280" height="120" class="backend" rx="5"/>
  <text x="190" y="1215" class="title" text-anchor="middle">11. BUILD RESPONSE</text>
  <text x="190" y="1235" class="subtitle" text-anchor="middle">app.py</text>
  <text x="60" y="1260" class="code">QueryResponse(</text>
  <text x="70" y="1278" class="code">  answer="...",</text>
  <text x="70" y="1296" class="code">  sources=[...],</text>
  <text x="60" y="1314" class="code">)</text>

  <!-- Arrow down -->
  <path d="M 190 1310 L 190 1350" class="arrow"/>
  <text x="200" y="1335" class="code">JSON response</text>

  <!-- STEP 12: Display -->
  <rect x="50" y="1350" width="280" height="120" class="frontend" rx="5"/>
  <text x="190" y="1375" class="title" text-anchor="middle">12. DISPLAY RESPONSE</text>
  <text x="190" y="1395" class="subtitle" text-anchor="middle">script.js - addMessage()</text>
  <text x="60" y="1420" class="label">• Parse markdown to HTML</text>
  <text x="60" y="1438" class="label">• Show sources in collapsible</text>
  <text x="60" y="1456" class="label">• Remove loading spinner</text>

  <!-- Final arrow to user -->
  <path d="M 190 1470 L 190 1510" class="arrow"/>

  <!-- USER SEES -->
  <rect x="50" y="1510" width="280" height="60" class="frontend" rx="5"/>
  <text x="190" y="1545" class="title" text-anchor="middle" font-size="20">✓ USER SEES ANSWER</text>

  <!-- Legend -->
  <rect x="1050" y="60" width="300" height="320" fill="#FAFAFA" stroke="#999" stroke-width="1" rx="5"/>
  <text x="1200" y="90" class="section-title" text-anchor="middle">Legend</text>

  <rect x="1070" y="110" width="40" height="30" class="frontend" rx="3"/>
  <text x="1120" y="130" class="label">Frontend (JavaScript)</text>

  <rect x="1070" y="150" width="40" height="30" class="backend" rx="3"/>
  <text x="1120" y="170" class="label">Backend API (FastAPI)</text>

  <rect x="1070" y="190" width="40" height="30" class="rag" rx="3"/>
  <text x="1120" y="210" class="label">RAG Orchestrator</text>

  <rect x="1070" y="230" width="40" height="30" class="ai" rx="3"/>
  <text x="1120" y="250" class="label">AI Generator (Claude)</text>

  <rect x="1070" y="270" width="40" height="30" class="tools" rx="3"/>
  <text x="1120" y="290" class="label">Search Tools</text>

  <rect x="1070" y="310" width="40" height="30" class="vector" rx="3"/>
  <text x="1120" y="330" class="label">Vector Store</text>

  <rect x="1070" y="350" width="40" height="30" class="db" rx="3"/>
  <text x="1120" y="370" class="label">ChromaDB</text>

  <!-- Key Data Flow -->
  <rect x="1050" y="400" width="300" height="280" fill="#FAFAFA" stroke="#999" stroke-width="1" rx="5"/>
  <text x="1200" y="430" class="section-title" text-anchor="middle">Key Data Flow</text>

  <text x="1060" y="460" class="code" font-weight="bold">Request:</text>
  <text x="1070" y="478" class="code">query: "What is computer use?"</text>
  <text x="1070" y="493" class="code">session_id: "abc123"</text>

  <text x="1060" y="520" class="code" font-weight="bold">Tool Call:</text>
  <text x="1070" y="538" class="code">name: "search_course_content"</text>
  <text x="1070" y="553" class="code">query: "computer use"</text>
  <text x="1070" y="568" class="code">course_name: "Building..."</text>

  <text x="1060" y="595" class="code" font-weight="bold">Vector Search:</text>
  <text x="1070" y="613" class="code">embedding → cosine similarity</text>
  <text x="1070" y="628" class="code">returns: top 5 chunks</text>

  <text x="1060" y="655" class="code" font-weight="bold">Response:</text>
  <text x="1070" y="673" class="code">answer: "Computer use is..."</text>
  <text x="1070" y="688" class="code">sources: ["Course - L0"]</text>

  <!-- Notes -->
  <rect x="1050" y="700" width="300" height="200" fill="#FFF9C4" stroke="#F9A825" stroke-width="2" rx="5"/>
  <text x="1200" y="730" class="section-title" text-anchor="middle">Notes</text>

  <text x="1060" y="760" class="label" font-weight="bold">Two Claude API Calls:</text>
  <text x="1070" y="778" class="label">1. Decide if search needed</text>
  <text x="1070" y="793" class="label">2. Generate final answer</text>

  <text x="1060" y="820" class="label" font-weight="bold">Embeddings Used:</text>
  <text x="1070" y="838" class="label">Sentence Transformer</text>
  <text x="1070" y="853" class="label">(all-MiniLM-L6-v2)</text>

  <text x="1060" y="880" class="label" font-weight="bold">Session Management:</text>
  <text x="1070" y="898" class="label">Maintains conversation</text>
  <text x="1070" y="913" class="label">context across queries</text>

  <!-- Flow summary on right -->
  <rect x="1050" y="920" width="300" height="180" fill="#E3F2FD" stroke="#1976D2" stroke-width="2" rx="5"/>
  <text x="1200" y="950" class="section-title" text-anchor="middle">Flow Summary</text>

  <text x="1060" y="980" class="label">1. User query → API</text>
  <text x="1060" y="998" class="label">2. RAG → Claude (decide)</text>
  <text x="1060" y="1016" class="label">3. Tool → Vector Search</text>
  <text x="1060" y="1034" class="label">4. ChromaDB → Find chunks</text>
  <text x="1060" y="1052" class="label">5. Claude → Generate answer</text>
  <text x="1060" y="1070" class="label">6. API → Return JSON</text>
  <text x="1060" y="1088" class="label">7. Frontend → Display</text>

</svg>